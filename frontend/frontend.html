<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>frontend</title>
</head>
<body>

    <div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>

    <script>
    
        let fonts = {
            target: 3,
            loaded: 0,
        }

        let roboto_400 = new FontFace("roboto_400", "url(https://fonts.gstatic.com/s/roboto/v29/KFOmCnqEu92Fr1Mu4mxK.woff2)");
        let roboto_mono_700 = new FontFace("roboto_mono_700", "url(https://fonts.gstatic.com/s/robotomono/v21/L0xuDF4xlVMF-BfR8bXMIhJHg45mwgGEFl0_Of2_ROW4.woff2)");
        let libre_bodoni_700 = new FontFace("libre_bodoni_700", "url(https://fonts.gstatic.com/s/librebodoni/v2/_Xm--H45qDWDYULr5OfyZudXzSBgY2oMBGte6GpY8WvTcQ.woff2)");
        async function font(f, r) {
            await f.load();
            document.fonts.add(f);
            r.loaded += 1;
        }

        font(roboto_400, fonts);
        font(roboto_mono_700, fonts);
        font(libre_bodoni_700, fonts);

        // @TODO
        // create_view() (directly creates a virtual element.)
        // delete_view() (directly deletes a virtual element)
        //update_views() executes like this: animate, link, lock. Then the update_dom() does the rest.

        let time = performance.now();
        let delta = 0;


        // @DONE
        function init_dom() {
            
            let dom = { 
                load: 1,
                
                width: document.documentElement.clientWidth,
                height: document.documentElement.clientHeight,
                
                h: document.head,
                b: document.body,
                e: [] 
            }

            dom.b.style.margin = "0px";
            dom.b.style.padding = "0px";
            dom.b.style.left = "0px";
            dom.b.style.top = "0px";
            dom.b.style.overflow = "hidden";

            let p = document.body.children[0];
            let c = p.children;
            dom.e.push(p);
            
            for (let i = 0; i < c.length; i++) {
                dom.e.push(c[i]);
            }
            for (let i = 0; i < dom.e.length; i++) {
                dom.e[i].style.position = "absolute";
                dom.e[i].style.margin = "0px";
                dom.e[i].style.padding = "0px";
                dom.e[i].style.border = "none";
                dom.e[i].style.left = "0px";
                dom.e[i].style.top = "0px";
                dom.e[i].style.width = "0px";
                dom.e[i].style.height = "0px";
                dom.e[i].style.zIndex = "0";
                dom.e[i].style.overflow = "hidden";
            }

            return dom;
        }

        // FLOAT
        let x0 = 0; // position
        let x1 = 1; // dimension
        let x2 = 2; // rotation
        let x3 = 3; // scale

        let y0 = 4;
        let y1 = 5;
        let y2 = 6;
        let y3 = 7;

        let z0 = 8;
        let z1 = 9;
        let z2 = 10;
        let z3 = 11;

        let opac = 12;
        let blur = 13;
        let cont = 14;
        let satu = 15;
        let gray = 16;
        let brig = 17;
        let sepi = 18;

        let red = 19;
        let green = 20;
        let blue = 21;

        let t_red = 22;
        let t_green = 23;
        let t_blue = 24;
        let t_size = 25;
        
        let b_red = 26;
        let b_green = 27;
        let b_blue = 28;
        let b_size = 29;
        let b_radius = 30;

        let s_red = 31;
        let s_green = 32;
        let s_blue = 33;
        let s_size = 34;
        let s_radius = 35;

        // STRING
        let text = 36;
        let t_font = 37;
        let b_x0 = 38;
        let b_x1 = 39;
        let b_y0 = 40;
        let b_y1 = 41;

        // @HERE
        function init_views(size, rt) {

            let v = {
                
                state: 0, // view state

                // FLOAT
                s: [], // property state
                c: [], // property current frame
                p: [], // property previous frame

                // LOCK NUMBER
                lop: [], // PROPERTY
                lot: [], // TARGET
                loo: [], // OFFESET
                lomi: [], // MIN
                loma: [], // MAX

                // LINK NUMBER
                lit: [],

                // ANIMATE NUMBER
                ar: [], // RUNNING
                ap: [], // PROGRESS
                at: [], // TIMER
                as: [], // SAMPLE
                ad: [], // DONE

                // STRING
            }

            // SPATIAL
            for (let i = 0; i < 12; i++) {
                
                v.s.push(new Int8Array(size));
                v.c.push(new Float32Array(size));
                v.p.push(new Float32Array(size));
                v.ar.push(new Int8Array(size));
                v.ap.push(new Float32Array(size));
                v.at.push(new Float64Array(size));
                v.as.push(new Int32Array(size));
                v.ad.push(new Int8Array(size));
            }

            // RENDER TARGETE
            v.c[x1][0] = rt.width;
            v.p[x1][0] = rt.width;
            v.c[y1][0] = rt.height;
            v.p[y1][0] = rt.height;

            return v;
        }

        // INIT
        let dom = init_dom();
        let v = init_views(dom.e.length, dom);

        // GET
        function x0_(i) { return v.c[x0][i]; }
        function x1_(i) { return v.c[x1][i]; }
        function x2_(i) { return v.c[x2][i]; }
        function x3_(i) { return v.c[x3][i]; }

        function y0_(i) { return v.c[y0][i]; }
        function y1_(i) { return v.c[y1][i]; }
        function y2_(i) { return v.c[y2][i]; }
        function y3_(i) { return v.c[y3][i]; }

        function z0_(i) { return v.c[y0][i]; }
        function z1_(i) { return v.c[y1][i]; }
        function z2_(i) { return v.c[y2][i]; }
        function z3_(i) { return v.c[y3][i]; }

        function opac_(i) { return v.c[opac][i]; }
        function blur_(i) { return v.c[blur][i]; }
        function cont_(i) { return v.c[cont][i]; }
        function satu_(i) { return v.c[satu][i]; }
        function gray_(i) { return v.c[gray][i]; }
        function brig_(i) { return v.c[brig][i]; }
        function sepi_(i) { return v.c[sepi][i]; }

        function red_(i) { return v.c[red][i]; }
        function green_(i) { return v.c[green][i]; }
        function blue_(i) { return v.c[blue][i]; }

        function t_red_(i) { return v.c[t_red][i]; }
        function t_green_(i) { return v.c[t_green][i]; }
        function t_blue_(i) { return v.c[t_blue][i]; }
        function t_size_(i) { return v.c[t_size][i]; }
        
        function b_red_(i) { return v.c[b_red][i]; }
        function b_green_(i) { return v.c[b_green][i]; }
        function b_blue_(i) { return v.c[b_blue][i]; }
        function b_size_(i) { return v.c[b_size][i]; }
        function b_radius_(i) { return v.c[b_radius][i]; }

        function s_red_(i) { return v.c[s_red][i]; }
        function s_green_(i) { return v.c[s_green][i]; }
        function s_blue_(i) { return v.c[s_blue][i]; }
        function s_size_(i) { return v.c[s_size][i]; }
        function s_radius_(i) { return v.c[s_radius][i]; }

        // STRING
        function text_(i) { return v.c[text][i]; }
        function t_font_(i) { return v.c[t_font][i]; }
        function b_x0_(i) { return v.c[b_x0][i]; }
        function b_x1_(i) { return v.c[b_x1][i]; }
        function b_y0_(i) { return v.c[b_y0][i]; }
        function b_y1_(i) { return v.c[b_y1][i]; }
        



        // SET
        function _x0(i, j) { v.c[x0][i] = j; }
        function _x1(i, j) { v.c[x1][i] = j; }
        function _x2(i, j) { v.c[x2][i] = j; }
        function _x3(i, j) { v.c[x3][i] = j; }

        function _y0(i, j) { v.c[y0][i] = j; }
        function _y1(i, j) { v.c[y1][i] = j; }
        function _y2(i, j) { v.c[y2][i] = j; }
        function _y3(i, j) { v.c[y3][i] = j; }

        function _z0(i, j) { v.c[z0][i] = j; }
        function _z1(i, j) { v.c[z1][i] = j; }
        function _z2(i, j) { v.c[z2][i] = j; }
        function _z3(i, j) { v.c[z3][i] = j; }

        function _opac(i, j) { v.c[opac][i] = j; }
        function _blur(i, j) { v.c[blur][i] = j; }
        function _cont(i, j) { v.c[cont][i] = j; }
        function _satu(i, j) { v.c[satu][i] = j; }
        function _gray(i, j) { v.c[gray][i] = j; }
        function _brig(i, j) { v.c[brig][i] = j; }
        function _sepi(i, j) { v.c[sepi][i] = j; }

        function _red(i, j) { v.c[red][i] = j; }
        function _green(i, j) { v.c[green][i] = j; }
        function _blue(i, j) { v.c[blue][i] = j; }

        function _t_red(i, j) { v.c[t_red][i] = j; }
        function _t_green(i, j) { v.c[t_green][i] = j; }
        function _t_blue(i, j) { v.c[t_blue][i] = j; }
        function _t_size(i, j) { v.c[t_size][i] = j; }
        
        function _b_red(i, j) { v.c[b_red][i] = j; }
        function _b_green(i, j) { v.c[b_green][i] = j; }
        function _b_blue(i, j) { v.c[b_blue][i] = j; }
        function _b_size(i, j) { v.c[b_size][i] = j; }
        function _b_radius(i, j) { v.c[b_radius][i] = j; }

        function _s_red(i, j) { v.c[s_red][i] = j; }
        function _s_green(i, j) { v.c[s_green][i] = j; }
        function _s_blue(i, j) { v.c[s_blue][i] = j; }
        function _s_size(i, j) { v.c[s_size][i] = j; }
        function _s_radius(i, j) { v.c[s_radius][i] = j; }

        // STRING
        function _text(i, j) { v.c[text][i] = j; }
        function _t_font(i, j) { v.c[t_font][i] = j; }
        function _b_x0(i, j) { v.c[b_x0][i] = j; }
        function _b_x1(i, j) { v.c[b_x1][i] = j; }
        function _b_y0(i, j) { v.c[b_y0][i] = j; }
        function _b_y1(i, j) { v.c[b_y1][i] = j; }



        // lock()
        // r_lock()
        // link()
        // r_link()
        // anim()
        // r_anim()

        // update_anims()
        // update_links()
        // update_locks()






        // @DONE
        function lock(views, sp, s, tp, t, offset, min, max) {

            views.c[sp][s] = views.c[tp][t] + offset;
            if (min !== null && views.c[sp][s] < min) { views.c[sp][s] = min; }
            else if (max !== null && views.c[sp][s] > max) { views.c[sp][s] = max; }
            return;
        }

        // @DONE
        function link(views, sp, s, tp, t, mult, min, max) {

            if (views.c[tp][t] < views.p[tp][t]) { views.c[sp][s] -= ((views.p[tp][t] - views.c[tp][t]) * mult); }
            else if (views.c[tp][t] > views.p[tp][t]) { views.c[sp][s] += ((views.c[tp][t] - views.p[tp][t]) * mult); }

            if (min !== null && views.c[sp][s] < min) { views.c[sp][s] = min; }
            else if (max !== null && views.c[sp][s] > max) { views.c[sp][s] = max; }
            return;
        }

        function update_links() {

        }

        // @DONE
        function lerp(p0, p1, i) {
            return ((p1 - p0) * i) + p0; 
        }

        // @DONE
        function quad(p0, p1, p2, i) {
            let l0 = lerp(p0, p1, i);
            let l1 = lerp(p1, p2, i);
            return lerp(l0, l1, i);
        }

        // @DONE
        function cube(p0, p1, p2, p3, i) {
            let q0 = quad(p0, p1, p2, i);
            let q1 = quad(p1, p2, p3, i);
            return lerp(q0, q1, i);
        }
        
        // @DONE // refactor into update function??
        function anim(views, sp, s, start, end, time, delay, curve) {

            if (views.ar[sp][s] === 0) {
                views.ad[sp][s] = 0;
                views.ar[sp][s] = 1;
                views.ap[sp][s] = 0.0;
                views.at[sp][s] = 0 - delay;
                views.c[sp][s] = start;
            } 

            // INVERT
            let dir = 1;
            let st = start;
            let en = end;
            if (end < start) { st = end; en = start; dir = -1; }
            let di = en - st;

            // CALCULATE
            views.at[sp][s] += delta;
            if (views.at[sp][s] < 0) { return; }
            let cr = 0;
            if (curve.length === 2) { cr = lerp(curve[0], curve[1], views.at[sp][s] / time); } 
            else if (curve.length === 3) { cr = quad(curve[0], curve[1], curve[2], views.at[sp][s] / time); }
            else if (curve.length === 4) { cr = cube(curve[0], curve[1], curve[2], curve[3], views.at[sp][s] / time); }
            let pr = ((di / time) * delta) * cr;
            views.ap[sp][s] += pr;
            views.c[sp][s] += (pr * dir);

            // DONE
            if (views.ap[sp][s] >= di || views.at[sp][s] >= time) { 
                views.c[sp][s] = end;
                views.ar[sp][s] = 0;
                views.ad[sp][s] = 1;
            }
        }

        function update_dom(dom, views) {

            dom.width = document.documentElement.clientWidth;
            dom.height = document.documentElement.clientHeight;

            // RESIZE EVENT
            let b = dom.b.getBoundingClientRect();
            if (b.width !== dom.width) {  b.width = dom.width; }
            if (b.height !== dom.height) { b.height = dom.height; }

            let i = 0;
            let len = dom.e.length;

            // @ADD simple diffing algorithm later
            // @ADD if a view contains text it's width and height = "auto"?
            // @ADD rounding of properties that are integers in the DOM

            while (i < len) { 
                dom.e[i].style.width = (views.c[x1][i] - views.c[x0][i]) + "px"; 
                i += 1; 
            } i = 0;
            while (i < len) { dom.e[i].style.height = (views.c[y1][i]- views.c[y0][i]) + "px"; i += 1; } i = 0;
            while (i < len) { dom.e[i].style.transform = "translate(" + views.c[x0][i] + "px, " + views.c[y0][i] + "px) " + "rotate(" + views.c[z2][i] + "deg)"; i += 1; } i = 0;


            // CLEAR EVENTS
            dom.load = 0;

        }


        function update_views(views, render_target) {

            views.c[x1][0] = render_target.width;
            views.c[y1][0] = render_target.height;

            let curve_line = [0.0, 2.0];
            let curve_quad = [0.0, 3.0, 0.0];
            let curve_cube = [2.0, 0.0, 2.0, 0.0];

            // STATE
            if (views.s[x0][1] === 0 && views.ad[x0][1] === 1) { views.s[x0][1] = 1; }
            else if (views.s[x0][1] === 1 && views.ad[x0][1] === 1) { views.s[x0][1] = 0; }

            // LOAD
            if (render_target.load === 1) {
                views.c[x0][1] = 300;
                render_target.e[1].style.borderStyle = "none";
                render_target.e[1].style.borderRadius = "15px";
                render_target.e[1].style.boxShadow = "0px 0.5px 7px rgb(175, 175, 175)";

                render_target.e[3].style.borderStyle = "none";
                render_target.e[3].style.borderRadius = "0px 0px 15px 15px";
                render_target.e[3].style.backgroundColor = "rgb(100, 100, 100)";

                render_target.e[2].style.backgroundColor = "rgb(200, 200, 200)";
                render_target.e[2].style.borderStyle = "none";
                render_target.e[2].style.boxShadow = "0px 0.5px 7px rgb(175, 175, 175)";
                render_target.e[2].style.fontFamily = "libre_bodoni_700";
                render_target.e[2].style.fontSize = "24px";
                render_target.e[2].style.color = "rgb(50, 50, 50)";
                render_target.e[2].textContent = "EMANUEL ALVGARD";

            }

            // LAYOUT
            lock(views, y0, 1, y0, 0, 300, null, null);
            lock(views, x1, 1, x0, 1, 300, null, null);
            lock(views, y1, 1, y1, 0, -300, null, null);

            //if (views.s[x0][1] === 0) { anim(views, x0, 1, 300, 900, 500, 500, curve_quad); }
            //else if (views.s[x0][1] === 1) { anim(views, x0, 1, 900, 300, 500, 500, curve_quad); }

            lock(views, x0, 3, x0, 1, 0, null, null);
            lock(views, x1, 3, x1, 1, 0, null, null);
            lock(views, y1, 3, y1, 1, 0, null, null);
            let a = (y1_(1) - y0_(1)) / 2;
            lock(views, y0, 3, y0, 1, a, null, null);

            lock(views, x1, 2, x1, 0, 0, null, null);
            lock(views, y1, 2, y0, 0, 100, null, null);


            // SAVE STATE
            for (let i = 0; i < views.c.length; i++) {
                for (let j = 0; j < views.c[i].length; j++) { 
                    if (views.c[i][j] !== views.p[i][j]) { views.p[i][j] = views.c[i][j]; }
                }
            }
            // CLEAR EVENTS
        }

        function main() {

            let new_time = performance.now();
            delta = new_time - time;
            time = new_time;
            
            if (fonts.loaded === fonts.target) {
                update_views(views, dom);
                update_dom(dom, views);
            }

            window.requestAnimationFrame(main);
        }

        main();
    
    </script>
</body>
</html>