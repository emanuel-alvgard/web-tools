<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>frontend</title>
</head>
<body style="opacity:1">

    <div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
    </div>

    <script>

        let time = performance.now();
        let delta = 0;


        // @DONE
        function init_dom() {
            
            let dom = { 
                load: 1,
                
                width: document.documentElement.clientWidth,
                height: document.documentElement.clientHeight,
                
                b: document.body,
                e: [] 
            }

            dom.b.style.margin = "0px";
            dom.b.style.padding = "0px";
            dom.b.style.left = "0px";
            dom.b.style.top = "0px";
            dom.b.style.overflow = "hidden";

            let p = document.body.children[0];
            let c = p.children;
            dom.e.push(p);
            
            for (let i = 0; i < c.length; i++) {
                dom.e.push(c[i]);
            }
            for (let i = 0; i < dom.e.length; i++) {
                dom.e[i].style.position = "absolute";
                dom.e[i].style.margin = "0px";
                dom.e[i].style.padding = "0px";
                dom.e[i].style.border = "solid";
                dom.e[i].style.left = "0px";
                dom.e[i].style.top = "0px";
                dom.e[i].style.width = "0px";
                dom.e[i].style.height = "0px";
                dom.e[i].style.zIndex = "0";
                dom.e[i].style.overflow = "hidden";
            }

            return dom;
        }

        // VIEW TYPE
        const view = {

            // STATES 0 - 99
            x0: 0, // position
            x1: 1, // dimension
            x2: 2, // rotation
            y0: 3,
            y1: 4,
            y2: 5,
            z0: 6,
            z1: 7,
            z2: 8,

            // EVENTS 100 - 199
            mouse_down: 100,
            mouse_up: 101
        }

        // @DONE
        function init_views(size, render_target) {

            let views = {
                s: [], //state
                c: [], // current frame
                p: [], // previous frame
                e: [], // event

                // ANIMATION
                ar: [], // RUNNING
                ap: [], // PROGRESS
                at: [], // TIMER
                as: [], // SAMPLE
                ad: [], // DONE
            }

            // STATE
            views.s.push(new Int8Array(size));

            // CURRENT
            views.c.push(new Float32Array(size)); // x0
            views.c.push(new Float32Array(size)); // x1
            views.c.push(new Float32Array(size)); // x2
            views.c.push(new Float32Array(size)); // y0
            views.c.push(new Float32Array(size)); // y1
            views.c.push(new Float32Array(size)); // y2
            views.c.push(new Float32Array(size)); // z0
            views.c.push(new Float32Array(size)); // z1
            views.c.push(new Float32Array(size)); // z2

            // PREVIOUS
            views.p.push(new Float32Array(size)); // x0
            views.p.push(new Float32Array(size)); // x1
            views.p.push(new Float32Array(size)); // x2
            views.p.push(new Float32Array(size)); // y0
            views.p.push(new Float32Array(size)); // y1
            views.p.push(new Float32Array(size)); // y2
            views.p.push(new Float32Array(size)); // z0
            views.p.push(new Float32Array(size)); // z1
            views.p.push(new Float32Array(size)); // z2
            
            // ANIMATION
            views.ar.push(new Int8Array(size));
            views.ap.push(new Float32Array(size));
            views.at.push(new Float64Array(size));
            views.as.push(new Int32Array(size));
            views.ad.push(new Int8Array(size));

            views.c[view.x1][0] = render_target.width;
            views.p[view.x1][0] = render_target.width;
            views.c[view.y1][0] = render_target.height;
            views.p[view.y1][0] = render_target.height;

            return views;
        }

        // @DONE
        function lock(views, sp, s, tp, t, offset, min, max) {

            views.c[sp][s] = views.c[tp][t] + offset;
            if (min !== null && views.c[sp][s] < min) { views.c[sp][s] = min; }
            else if (max !== null && views.c[sp][s] > max) { views.c[sp][s] = max; }
            return;
        }

        // @DONE
        function link(views, sp, s, tp, t, mult, min, max) {

            if (views.c[tp][t] < views.p[tp][t]) { views.c[sp][s] -= ((views.p[tp][t] - views.c[tp][t]) * mult); }
            else if (views.c[tp][t] > views.p[tp][t]) { views.c[sp][s] += ((views.c[tp][t] - views.p[tp][t]) * mult); }

            if (min !== null && views.c[sp][s] < min) { views.c[sp][s] = min; }
            else if (max !== null && views.c[sp][s] > max) { views.c[sp][s] = max; }
            return;
        }

        // @DONE
        function lerp(p0, p1, i) {
            return ((p1 - p0) * i) + p0; 
        }

        // @DONE
        function quad(p0, p1, p2, i) {
            let l0 = lerp(p0, p1, i);
            let l1 = lerp(p1, p2, i);
            return lerp(l0, l1, i);
        }

        // @DONE
        function cube(p0, p1, p2, p3, i) {
            let q0 = quad(p0, p1, p2, i);
            let q1 = quad(p1, p2, p3, i);
            return lerp(q0, q1, i);
        }
        
        // @DONE
        function anim(views, sp, s, start, end, time, delay, curve) {

            if (views.ar[sp][s] === 0) {
                views.ad[sp][s] = 0;
                views.ar[sp][s] = 1;
                views.ap[sp][s] = 0.0;
                views.at[sp][s] = 0 - delay;
                views.c[sp][s] = start;
            } 

            // INVERT
            let dir = 1;
            let st = start;
            let en = end;
            if (end < start) { st = end; en = start; dir = -1; }
            let di = en - st;

            // CALCULATE
            views.at[sp][s] += delta;
            if (views.at[sp][s] < 0) { return; }
            let cr = 0;
            if (curve.length === 2) { cr = lerp(curve[0], curve[1], views.at[sp][s] / time); } 
            else if (curve.length === 3) { cr = quad(curve[0], curve[1], curve[2], views.at[sp][s] / time); }
            else if (curve.length === 4) { cr = cube(curve[0], curve[1], curve[2], curve[3], views.at[sp][s] / time); }
            let pr = ((di / time) * delta) * cr;
            views.ap[sp][s] += pr;
            views.c[sp][s] += (pr * dir);

            // DONE
            if (views.ap[sp][s] >= di || views.at[sp][s] >= time) { 
                views.c[sp][s] = end;
                views.ar[sp][s] = 0;
                views.ad[sp][s] = 1;
            }
        }

        function update_dom(dom, views) {

            dom.width = document.documentElement.clientWidth;
            dom.height = document.documentElement.clientHeight;

            // RESIZE EVENT
            let b = dom.b.getBoundingClientRect();
            if (b.width !== dom.width) {  b.width = dom.width; }
            if (b.height !== dom.height) { b.height = dom.height; }

            let i = 0;
            let len = dom.e.length;

            // @ADD simple diffing algorithm later

            while (i < len) { dom.e[i].style.width = (views.c[view.x1][i] - views.c[view.x0][i]) + "px"; i += 1; } i = 0;
            while (i < len) { dom.e[i].style.height = (views.c[view.y1][i]- views.c[view.y0][i]) + "px"; i += 1; } i = 0;
            while (i < len) { dom.e[i].style.transform = "translate(" + views.c[view.x0][i] + "px, " + views.c[view.y0][i] + "px) " + "rotate(" + views.c[view.z2][i] + "deg)"; i += 1; } i = 0;


            // CLEAR EVENTS
            dom.load = 0;

        }


        function update_views(views, render_target) {

            views.c[view.x1][0] = render_target.width;
            views.c[view.y1][0] = render_target.height;

            // STATE
            if (views.s[view.x0][1] === 0 && views.ad[view.x0][1] === 1) { views.s[view.x0][1] = 1; }
            else if (views.s[view.x0][1] === 1 && views.ad[view.x0][1] === 1) { views.s[view.x0][1] = 0; }

            // LOAD
            if (render_target.load === 1) {
                views.c[view.x0][1] = 300;
            }

            // LAYOUT
            lock(views, view.y0, 1, view.y0, 0, 300, null, null);
            lock(views, view.x1, 1, view.x0, 1, 300, null, null);
            lock(views, view.y1, 1, view.y1, 0, -300, null, null);

            lock(views, view.x1, 2, view.x1, 0, 0, null, null);
            lock(views, view.y1, 2, view.y0, 0, 100, null, null);

            

            // ANIMATION
            let curve_line = [0.0, 2.0];
            let curve_quad = [0.0, 3.0, 0.0];
            let curve_cube = [2.0, 0.0, 2.0, 0.0];

            //if (views.s[view.x0][1] === 0) { anim(views, view.x0, 1, 300, 900, 300, 500, curve_quad); }
            //else if (views.s[view.x0][1] === 1) { anim(views, view.x0, 1, 900, 300, 300, 500, curve_quad); }

            // SAVE STATE
            for (let i = 0; i < views.c.length; i++) {
                for (let j = 0; j < views.c[i].length; j++) { 
                    if (views.c[i][j] !== views.p[i][j]) { views.p[i][j] = views.c[i][j]; }
                }
            }
            // CLEAR EVENTS
        }
       
        let dom = init_dom();
        let views = init_views(dom.e.length, dom);

        function main() {

            let new_time = performance.now();
            delta = new_time - time;
            time = new_time;

            update_views(views, dom);
            update_dom(dom, views);

            window.requestAnimationFrame(main);
        }

        main();
    
    </script>
</body>
</html>