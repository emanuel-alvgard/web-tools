<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>frontend</title>
</head>
<body style="opacity:1">

    <div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
    </div>

    <script>

        // QUEUE STRUCTURE
        // @DONE
        function queue_create(size) {

            let queue = {
                data: null,
                start: 0,
                end: 0,
                count: 0
            }

            let data = new Array(size);
            let i = 0;
            while (i < size) {
                data[i] = null;
                i += 1;
            }

            queue.data = data;

            return queue;
        }

        // @DONE
        function queue_add(subject, target) {

            let len = target.data.length;
            let start = target.start;
            let end = target.end;
            let count = target.count;

            if (end === start && count !== 0) { return -1; }

            target.data[end] = subject;
            target.count += 1;
            end += 1;

            if (end === len) { target.end = 0; }
            else { target.end = end; }

            return 1;
        }

        // @DONE
        function queue_remove(target) {

            let len = target.data.length;
            let start = target.start;
            let end = target.end;
            let count = target.count;

            if (start === end && count === 0) { return -1; }

            let result = target.data[start];
            target.data[start] = null;
            target.count -= 1;
            start += 1;

            if (start === len) { target.start = 0; }
            else { target.start = start; }

            return result;
        }

        const x0 = 0; // position
        const x1 = 1; // dimension
        const x2 = 2; // rotation
        const y0 = 3;
        const y1 = 4;
        const y2 = 5;
        const z0 = 6;
        const z1 = 7;
        const z2 = 8;

        // SPATIAL ENGINE
        let body = document.body;

        function init_body(b) {
            b.style.margin = "0px";
            b.style.padding = "0px";
            b.style.left = "0px";
            b.style.top = "0px";
            b.style.overflow = "hidden";
        }

        init_body(body);


        function update_body(b) {

            width = document.documentElement.clientWidth + "";
            height = document.documentElement.clientHeight + "";

            // RESIZE EVENT
            if (b.style.width !== width) { b.style.width = width + "px"; }
            if (b.style.height !== height) { b.style.height = height + "px"; }
        }


        let elements = {
            object: [],
            property: [[], [], [], [], [], [], [], [], []],

            // RELATION
            rel_free: null,

            rel_subject_id: [],
            rel_subject_property: [],
            rel_target_id: [],
            rel_target_property: [],
            rel_offset: []
        }


        // @DONE
        function DOM_elements(e, result) {
            let i = 0;
            while (i < e.length) {
              
                result.object.push(e[i]);

                if (e[i].children.length > 0) {
                    DOM_elements(e[i].children, result);
                }
                i += 1;
            }
            return;
        }

        // @DONE
        function init_elements(body_children, result) {

            DOM_elements(body_children, result);
            result.object.pop();
            result.rel_free = queue_create(result.object.length);

            let i = 0;
            while (i < result.object.length) {
                result.property[x0].push(0.0); // position
                result.property[x1].push(0.0); // dimension
                result.property[x2].push(0.0); // rotation
                result.property[y0].push(0.0);
                result.property[y1].push(0.0);
                result.property[y2].push(0.0);
                result.property[z0].push(0.0);
                result.property[z1].push(0.0);
                result.property[z2].push(0.0);

                queue_add(i, result.rel_free);
                result.rel_subject_id.push(-1);
                result.rel_subject_property.push(-1);
                result.rel_target_id.push(-1);
                result.rel_target_property.push(-1);
                result.rel_offset.push(0);

                result.object[i].style.position = "absolute";
                result.object[i].style.margin = "0px";
                result.object[i].style.padding = "0px";
                result.object[i].style.border = "solid";
                result.object[i].style.left = "0px";
                result.object[i].style.top = "0px";
                result.object[i].style.width = "0px";
                result.object[i].style.height = "0px";
                result.object[i].style.zIndex = "0";
                result.object[i].style.overflow = "hidden";
                i += 1;
            }

        }

        init_elements(body.children, elements);

        function render(e) {

            let i = 0;
            let len = e.object.length;

            // @ADD simple diffing algorithm later

            while (i < len) { e.object[i].style.width = (e.property[x1][i] - e.property[x0][i]) + "px"; i += 1; } i = 0;
            while (i < len) { e.object[i].style.height = (e.property[y1][i]- e.property[y0][i]) + "px"; i += 1; } i = 0;
            while (i < len) { e.object[i].style.transform = "translate(" + e.property[x0][i] + "px, " + e.property[y0][i] + "px) " + "rotate(" + e.property[z2][i] + "deg)"; i += 1; } i = 0;
        }

        console.log(elements);


        // RELATION
        // @HERE
        function relation(e, subject_property, subject_id, target_property, target_id, offset) {

            let i = queue_remove(e.rel_free);
            if (i === -1) { return; }
            e.rel_offset[i] = offset;
            e.rel_subject_property[i] = subject_property;
            e.rel_subject_id[i] = subject_id;
            e.rel_target_property[i] = target_property;
            e.rel_target_id[i] = target_id;
            return i;
        }

        // @TEST
        elements.object[0].style.border = "none";

        // HEADER
        let header_height = 100;

        // add this to a layout function
        relation(elements, x0, 1, x0, 0, 0);
        relation(elements, x1, 1, x1, 0, 0);
        relation(elements, y0, 1, y0, 0, 0);
        relation(elements, y1, 1, y0, 0, 100);

        // MENU
        relation(elements, x0, 2, x0, 1, 25);
        relation(elements, y0, 2, y0, 1, (header_height / 2));

        function remove_relation(e, index) { 

            e.rel_offset[index] = 0;
            e.rel_subject_property[index] = -1;
            e.rel_subject_id[index] = -1;
            e.rel_target_property[index] = -1;
            e.rel_target_id[index] = -1;
            queue_add(index, e.rel_free);
        }

        // @NOT
        function update_relations(e) {

            let len = e.rel_subject_id.length;
            let i = 0;
            while (i < len) {
                if (e.rel_subject_id[i] === -1) { i += 1; continue; }
                e.property[e.rel_subject_property[i]][e.rel_subject_id[i]] = 
                e.property[e.rel_target_property[i]][e.rel_target_id[i]] + 
                e.rel_offset[i];
                i += 1;
            }

            // removes all relations here

        }

        function update_elements(e) {

            e.property[x1][0] = document.documentElement.clientWidth;
            e.property[y1][0] = document.documentElement.clientHeight;

            update_relations(e);
        }

        // USER DEFINED
        function init_layout() {}

        function update_layout(e) {}

        let layout_data = []; // contains different elements-objects
        let layout_functions = []; // contains different update-functions

        function main() {

            update_body(body);
            update_elements(elements);
            update_layout(elements);
            render(elements);

            window.requestAnimationFrame(main);
        }

        main();

    </script>
</body>
</html>