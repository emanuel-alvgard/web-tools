<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>frontend</title>
</head>
<body style="opacity:1">

    <div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
    </div>

    <script>

        let time = performance.now();
        let delta = 0;


        // @DONE
        function init_dom() {
            
            let dom = { 
                load: 1,
                
                width: document.documentElement.clientWidth,
                height: document.documentElement.clientHeight,
                
                b: document.body,
                e: [] 
            }

            dom.b.style.margin = "0px";
            dom.b.style.padding = "0px";
            dom.b.style.left = "0px";
            dom.b.style.top = "0px";
            dom.b.style.overflow = "hidden";

            let p = document.body.children[0];
            let c = p.children;
            dom.e.push(p);
            
            for (let i = 0; i < c.length; i++) {
                dom.e.push(c[i]);
            }
            for (let i = 0; i < dom.e.length; i++) {
                dom.e[i].style.position = "absolute";
                dom.e[i].style.margin = "0px";
                dom.e[i].style.padding = "0px";
                dom.e[i].style.border = "solid";
                dom.e[i].style.left = "0px";
                dom.e[i].style.top = "0px";
                dom.e[i].style.width = "0px";
                dom.e[i].style.height = "0px";
                dom.e[i].style.zIndex = "0";
                dom.e[i].style.overflow = "hidden";
            }

            return dom;
        }

        // VIEW TYPE
        const view = {

            // STATES 0 - 99
            x0: 0, // position
            x1: 1, // dimension
            x2: 2, // rotation
            y0: 3,
            y1: 4,
            y2: 5,
            z0: 6,
            z1: 7,
            z2: 8,

            // EVENTS 100 - 199
            mouse_down: 100,
            mouse_up: 101
        }

        // @DONE
        function init_views(size, render_target) {

            let views = {
                s: [], // state current frame
                p: [], // state previous frame
                e: [], // event

                // ANIMATION
                ar: [], // RUNNING
                ap: [], // PROGRESS
                at: [], // TIMER
                as: [], // SAMPLE
            }

            // STATE
            views.s.push(new Float32Array(size)); // x0
            views.s.push(new Float32Array(size)); // x1
            views.s.push(new Float32Array(size)); // x2
            views.s.push(new Float32Array(size)); // y0
            views.s.push(new Float32Array(size)); // y1
            views.s.push(new Float32Array(size)); // y2
            views.s.push(new Float32Array(size)); // z0
            views.s.push(new Float32Array(size)); // z1
            views.s.push(new Float32Array(size)); // z2

            // PREVIOUS
            views.p.push(new Float32Array(size)); // x0
            views.p.push(new Float32Array(size)); // x1
            views.p.push(new Float32Array(size)); // x2
            views.p.push(new Float32Array(size)); // y0
            views.p.push(new Float32Array(size)); // y1
            views.p.push(new Float32Array(size)); // y2
            views.p.push(new Float32Array(size)); // z0
            views.p.push(new Float32Array(size)); // z1
            views.p.push(new Float32Array(size)); // z2
            
            // ANIMATION
            for (let i = 0; i < size; i++) {
                views.ar.push(new Int8Array(views.s.length));
                views.ap.push(new Float32Array(views.s.length));
                views.at.push(new Float64Array(views.s.length));
                views.as.push(new Int32Array(views.s.length));
            }

            views.s[view.x1][0] = render_target.width;
            views.p[view.x1][0] = render_target.width;
            views.s[view.y1][0] = render_target.height;
            views.p[view.y1][0] = render_target.height;

            return views;
        }

        // @DONE
        function lock(views, sp, s, tp, t, offset, min, max) {

            views.s[sp][s] = views.s[tp][t] + offset;
            if (min !== null && views.s[sp][s] < min) { views.s[sp][s] = min; }
            else if (max !== null && views.s[sp][s] > max) { views.s[sp][s] = max; }
            return;
        }

        // @DONE
        function link(views, sp, s, tp, t, mult, min, max) {

            if (views.s[tp][t] < views.p[tp][t]) { views.s[sp][s] -= ((views.p[tp][t] - views.s[tp][t]) * mult); }
            else if (views.s[tp][t] > views.p[tp][t]) { views.s[sp][s] += ((views.s[tp][t] - views.p[tp][t]) * mult); }

            if (min !== null && views.s[sp][s] < min) { views.s[sp][s] = min; }
            else if (max !== null && views.s[sp][s] > max) { views.s[sp][s] = max; }
            return;
        }
        
        function anim() {}

        function update_dom(dom, views) {

            dom.width = document.documentElement.clientWidth;
            dom.height = document.documentElement.clientHeight;

            // RESIZE EVENT
            let b = dom.b.getBoundingClientRect();
            if (b.width !== dom.width) {  b.width = dom.width; }
            if (b.height !== dom.height) { b.height = dom.height; }

            let i = 0;
            let len = dom.e.length;

            // @ADD simple diffing algorithm later

            while (i < len) { dom.e[i].style.width = (views.s[view.x1][i] - views.s[view.x0][i]) + "px"; i += 1; } i = 0;
            while (i < len) { dom.e[i].style.height = (views.s[view.y1][i]- views.s[view.y0][i]) + "px"; i += 1; } i = 0;
            while (i < len) { dom.e[i].style.transform = "translate(" + views.s[view.x0][i] + "px, " + views.s[view.y0][i] + "px) " + "rotate(" + views.s[view.z2][i] + "deg)"; i += 1; } i = 0;


            // CLEAR EVENTS
            dom.load = 0;

        }


        function update_views(views, render_target) {

            views.s[view.x1][0] = render_target.width;
            views.s[view.y1][0] = render_target.height;

            // LOAD
            if (render_target.load === 1) {
                views.s[view.x1][1] = 500;
            }

            // LAYOUT
            lock(views, view.x0, 1, view.x0, 0, 300, null, null);
            lock(views, view.y0, 1, view.y0, 0, 300, null, null);
            link(views, view.x1, 1, view.x1, 0, 0.1, 400, 520);
            lock(views, view.y1, 1, view.y1, 0, -300, null, null);

            // SAVE STATE
            for (let i = 0; i < views.s.length; i++) {
                for (let j = 0; j < views.s[i].length; j++) { 
                    if (views.s[i][j] !== views.p[i][j]) { views.p[i][j] = views.s[i][j]; }
                }
            }

            // CLEAR EVENTS
        }

       
        let dom = init_dom();
        let views = init_views(6, dom);

        function main() {

            let new_time = performance.now();
            delta = new_time - time;
            time = new_time;

            update_views(views, dom);
            update_dom(dom, views);

            window.requestAnimationFrame(main);
        }

        main();
    
    </script>
</body>
</html>