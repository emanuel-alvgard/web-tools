<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>frontend</title>
</head>
<body style="opacity:1">

    <div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
        <div>hello</div>
    </div>

    <script>

        // PROPERTIES
        const x0 = 0; // position
        const x1 = 1; // dimension
        const x2 = 2; // rotation
        const y0 = 3;
        const y1 = 4;
        const y2 = 5;
        const z0 = 6;
        const z1 = 7;
        const z2 = 8;

        let body = document.body;

        let elements = {
            object: [],
            property: [], // 2D array

            // RELATION 2D arrays
            rel_free: null,
            rel_subject_id: [],
            rel_subject_property: [],
            rel_target_id: [],
            rel_target_property: [],
            rel_offset: []
        }

        let layouts = [];

        function init_body(b) {
            b.style.margin = "0px";
            b.style.padding = "0px";
            b.style.left = "0px";
            b.style.top = "0px";
            b.style.overflow = "hidden";
        }

        init_body(body);


        function update_body(b) {

            width = document.documentElement.clientWidth + "";
            height = document.documentElement.clientHeight + "";

            // RESIZE EVENT
            if (b.style.width !== width) { b.style.width = width + "px"; }
            if (b.style.height !== height) { b.style.height = height + "px"; }
        }

        // @DONE
        function DOM_elements(e, result) {
            let i = 0;
            while (i < e.length) {
              
                result.object.push(e[i]);

                if (e[i].children.length > 0) {
                    DOM_elements(e[i].children, result);
                }
                i += 1;
            }
            return;
        }

        // @DONE
        function init_elements(body_children, result) {

            DOM_elements(body_children, result);
            result.object.pop();
            result.rel_free = queue_create(result.object.length);

            let len = result.object.length;
            result.property.push(new Float32Array(len));
            result.property.push(new Float32Array(len));
            result.property.push(new Float32Array(len));
            result.property.push(new Float32Array(len));
            result.property.push(new Float32Array(len));
            result.property.push(new Float32Array(len));
            result.property.push(new Float32Array(len));
            result.property.push(new Float32Array(len));
            result.property.push(new Float32Array(len));

            result.rel_free.push(new Int8Array(len));
            
            let i = 0;
            while (i < len) {

                result.rel_subject_id.push(new Int32Array(result.property.length));
                result.rel_subject_id.fill(-1);

                result.rel_subject_property.push(new Int8Array(result.property.length));
                result.rel_subject_property.fill(-1);

                result.rel_target_id.push(new Int32Array(result.property.length));
                result.rel_target_id.fill(-1);

                result.rel_target_property.push(new Int8Array(result.property.length));
                result.rel_target_property.fill(-1);

                result.rel_offset.push(new Int32Array(result.property.length));
                result.rel_offset.fill(-1);

                result.object[i].style.position = "absolute";
                result.object[i].style.margin = "0px";
                result.object[i].style.padding = "0px";
                result.object[i].style.border = "solid";
                result.object[i].style.left = "0px";
                result.object[i].style.top = "0px";
                result.object[i].style.width = "0px";
                result.object[i].style.height = "0px";
                result.object[i].style.zIndex = "0";
                result.object[i].style.overflow = "hidden";
                i += 1;
            }

        }

        init_elements(body.children, elements);

        function render(e) {

            let i = 0;
            let len = e.object.length;

            // @ADD simple diffing algorithm later

            while (i < len) { e.object[i].style.width = (e.property[x1][i] - e.property[x0][i]) + "px"; i += 1; } i = 0;
            while (i < len) { e.object[i].style.height = (e.property[y1][i]- e.property[y0][i]) + "px"; i += 1; } i = 0;
            while (i < len) { e.object[i].style.transform = "translate(" + e.property[x0][i] + "px, " + e.property[y0][i] + "px) " + "rotate(" + e.property[z2][i] + "deg)"; i += 1; } i = 0;
        }

        console.log(elements);


        // RELATION
        // @DONE
        function add_relation(e, subject_property, subject_id, target_property, target_id, offset) {

            if (e.rel_free[subject_id] >= e.subject_property[subject_id].length) { return -1; }
            // @HERE
            e.rel_subject_property[i] = subject_property;
            e.rel_subject_id[i] = subject_id;
            e.rel_target_property[i] = target_property;
            e.rel_target_id[i] = target_id;
            return i;
        }

        function enable_relation() { }
        function disable_relation() { }

        function remove_relation(e, index) {

            e.rel_offset[index] = 0;
            e.rel_subject_property[index] = -1;
            e.rel_subject_id[index] = -1;
            e.rel_target_property[index] = -1;
            e.rel_target_id[index] = -1;
            queue_add(index, e.rel_free);
        }

        // @DONE
        function update_relations(e) {

            let len = e.rel_subject_id.length;
            let i = 0;
            while (i < len) {
                if (e.rel_subject_id[i] === -1) { i += 1; continue; }

                // UPDATE
                e.property[e.rel_subject_property[i]][e.rel_subject_id[i]] =
                e.property[e.rel_target_property[i]][e.rel_target_id[i]] + 
                e.rel_offset[i];

                // REMOVE
                e.rel_offset[i] = 0;
                e.rel_subject_property[i] = -1;
                e.rel_subject_id[i] = -1;
                e.rel_target_property[i] = -1;
                e.rel_target_id[i] = -1;
                queue_add(i, e.rel_free);
                i += 1;
            }
        }

        function update_elements(e) {

            e.property[x1][0] = document.documentElement.clientWidth;
            e.property[y1][0] = document.documentElement.clientHeight;

            update_relations(e);
        }

        layouts.push(function (e) {

            if (e.property[x1][0] > 2000) { return; }

            e.object[0].style.border = "none";

            // BOX 1
            add_relation(e, x0, 1, x0, 0, 300);
            add_relation(e, x1, 1, x1, 0, -300);
            add_relation(e, y0, 1, y0, 0, 300);
            add_relation(e, y1, 1, y1, 0, -300);

            // BOX 2
            add_relation(e, x0, 2, x0, 1, 100);
            add_relation(e, x1, 2, x0, 2, 100);
            add_relation(e, y0, 2, y0, 1, 100);
            add_relation(e, y1, 2, y1, 1, -100);
        });

        function update_layout(e, l) {

            let len = l.length;
            let i = 0;
            while (i < len) {
                l[i](e);
                i += 1;
            }
        }

        function main() {

            update_body(body);
            update_layout(elements, layouts);
            update_elements(elements);
            render(elements);

            window.requestAnimationFrame(main);
        }

        main();

    </script>
</body>
</html>